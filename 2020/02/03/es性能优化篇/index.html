<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><title>es性能优化篇 | SamLai'Blog</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="[object Object]"><meta name="designer" content="minfive"><meta name="keywords" content="java,spring,spring-boot,mq,docker"><meta name="description" content="A Java Programmer,Never To Late..."><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="https://zuoyoulai.github.io/2020/02/03/es%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%AF%87/index.html"><link rel="icon" type="image/png" href="https://image.baidu.com/search/detail?ct=503316480&z=&tn=baiduimagedetail&ipn=d&word=icon%20%E7%A7%91%E6%8A%80&step_word=&ie=utf-8&in=&cl=2&lm=-1&st=-1&hd=&latest=&copyright=&cs=380845249,1544155353&os=2032694909,351738893&simid=0,0&pn=91&rn=1&di=90750&ln=817&fr=&fmq=1577256973347_R&ic=&s=undefined&se=&sme=&tab=0&width=&height=&face=undefined&is=0,0&istype=2&ist=&jit=&bdtype=0&spn=0&pi=0&gsm=0&objurl=http%3A%2F%2Fpic.51yuansu.com%2Fpic3%2Fcover%2F03%2F71%2F81%2F5bfe105f5c40d_610.jpg&rpstart=0&rpnum=0&adpicid=0&force=undefined" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="左之右"><link rel="stylesheet" href="/scss/views/page/post.css"><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="左之右" type="application/atom+xml"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(https://i.loli.net/2019/12/30/L5a7ElW9COPd8eK.gif)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="左之右" alt="左之右"><img src="https://i.loli.net/2019/12/26/t8TdlczoUKpMw6X.jpg" alt="左之右"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="https://i.loli.net/2020/01/31/3KObQ8fWtnivdJg.png" alt="es性能优化篇"></div><header class="post__info"><h1 class="post__title">es性能优化篇</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="https://github.com/ZuoYouLai" target="_blank" rel="noopener">samlai</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2020-02-03</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/es/">Es</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-eye"></i><ul class="mark__list clearfix"><li id="busuanzi_container_page_pv" class="mark__item"><span id="busuanzi_value_page_pv"></span>次</li></ul></div></div></header><div class="post__content"><h2><span id="es-xing-neng-you-hua-pian">es性能优化篇</span><a href="#es-xing-neng-you-hua-pian" class="header-anchor"></a></h2><div class="toc"><ul><li><a href="#suo-yin-fang-mian-de-you-hua">索引方面的优化</a></li><li><a href="#fu-wu-qi-fang-mian-de-you-hua">服务器方面的优化</a></li></ul></div><ul><li><p>文章的参考来自: <a href="https://blog.csdn.net/u014646662/article/details/99293604" target="_blank" rel="noopener">https://blog.csdn.net/u014646662/article/details/99293604</a></p></li><li><p>优化的层面 : 索引方面 + 服务器层面</p></li></ul><h3><span id="suo-yin-fang-mian-de-you-hua">索引方面的优化</span><a href="#suo-yin-fang-mian-de-you-hua" class="header-anchor"></a></h3><h4><span id="zeng-jia-refresh-shi-jian-jian-ge">增加 Refresh 时间间隔</span><a href="#zeng-jia-refresh-shi-jian-jian-ge" class="header-anchor"></a></h4><ol><li><p>Elasticsearch 在写入数据时候，采用延迟写入的策略，即数据先写到内存中，当超过默认 1 秒</p></li><li><p>延长 refresh 时间间隔，可以有效的减少 segment 合并压力，提供索引速度。在做全链路跟踪的过程中，我们就将 index.refresh_interval 设置为 30s，减少 refresh 次数</p></li><li><p>在进行全量索引时，可以将 refresh 次数临时关闭，即 index.refresh_interval 设置为 -1，数据导入成功后再打开到正常模式，比如 30s</p></li><li><p>修改主配置文件 elasticsearch.yml 或者 Rest API 都可以对 index.refresh_interval 进行修改，增大该属性可以提升写入吞吐</p></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">PUT  &#x2F;_template&#x2F;&#123;TEMPLATE_NAME&#125;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;template&quot;:&quot;&#123;INDEX_PATTERN&#125;&quot;,</span><br><span class="line">  &quot;settings&quot; : &#123;</span><br><span class="line">    &quot;index.refresh_interval&quot; : &quot;30s&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">PUT &#123;INDEX_PAATERN&#125;&#x2F;_settings</span><br><span class="line">&#123;</span><br><span class="line">    &quot;index.refresh_interval&quot; : &quot;30s&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="jian-shao-fu-ben-shu-liang">减少副本数量</span><a href="#jian-shao-fu-ben-shu-liang" class="header-anchor"></a></h4><ul><li><p>Elasticsearch 默认副本数量为 3 个（7.x默认一个分片、一个副本），虽然这样会提高集群的可用性，增加搜索的并发数，但是同时也会影响写入索引的效率</p></li><li><p>在索引过程中，需要把更新的文档发到副本节点上，等副本节点生效后在进行返回结束。 使用 Elasticsearch 做业务搜索的时候，建议副本数目还是设置为 3 个，但是像内部 ELK 日志系统、分布式跟踪系统中，完全可以将副本数目设置为 1 个</p></li><li><p>在数据导入时，或是reindex的时候，可以将副本数改为0，等操作完毕后，在恢复事先定义的数目</p></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_replicas&quot;:0 </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h4><span id="kai-qi-yi-bu-shua-xie">开启异步刷写</span><a href="#kai-qi-yi-bu-shua-xie" class="header-anchor"></a></h4><ul><li>如果允许数据丢失，可以对特定 index 开启异步刷写：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PUT  &#x2F;_template&#x2F;&#123;TEMPLATE_NAME&#125;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;template&quot;:&quot;&#123;INDEX_PATTERN&#125;&quot;,</span><br><span class="line">  &quot;settings&quot; : &#123;</span><br><span class="line">    &quot;index.translog.durability&quot;: &quot;async&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">PUT  &#123;INDEX_PAATERN&#125;&#x2F;_settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;index.translog.durability&quot;: &quot;async&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="kai-qi-man-cha-xun-ri-zhi">开启慢查询日志</span><a href="#kai-qi-man-cha-xun-ri-zhi" class="header-anchor"></a></h4><ul><li>不论是数据库还是搜索引擎，对于问题的排查，开启慢查询日志是十分必要的，ES 开启慢查询的方式有多种，但是最常用的是调用模板 API 进行全局设置</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">PUT  &#x2F;_template&#x2F;&#123;TEMPLATE_NAME&#125;</span><br><span class="line">&#123;</span><br><span class="line"> </span><br><span class="line">  &quot;template&quot;:&quot;&#123;INDEX_PATTERN&#125;&quot;,</span><br><span class="line">  &quot;settings&quot; : &#123;</span><br><span class="line">    &quot;index.indexing.slowlog.level&quot;: &quot;INFO&quot;,</span><br><span class="line">    &quot;index.indexing.slowlog.threshold.index.warn&quot;: &quot;10s&quot;,</span><br><span class="line">    &quot;index.indexing.slowlog.threshold.index.info&quot;: &quot;5s&quot;,</span><br><span class="line">    &quot;index.indexing.slowlog.threshold.index.debug&quot;: &quot;2s&quot;,</span><br><span class="line">    &quot;index.indexing.slowlog.threshold.index.trace&quot;: &quot;500ms&quot;,</span><br><span class="line">    &quot;index.indexing.slowlog.source&quot;: &quot;1000&quot;,</span><br><span class="line">    &quot;index.search.slowlog.level&quot;: &quot;INFO&quot;,</span><br><span class="line">    &quot;index.search.slowlog.threshold.query.warn&quot;: &quot;10s&quot;,</span><br><span class="line">    &quot;index.search.slowlog.threshold.query.info&quot;: &quot;5s&quot;,</span><br><span class="line">    &quot;index.search.slowlog.threshold.query.debug&quot;: &quot;2s&quot;,</span><br><span class="line">    &quot;index.search.slowlog.threshold.query.trace&quot;: &quot;500ms&quot;,</span><br><span class="line">    &quot;index.search.slowlog.threshold.fetch.warn&quot;: &quot;1s&quot;,</span><br><span class="line">    &quot;index.search.slowlog.threshold.fetch.info&quot;: &quot;800ms&quot;,</span><br><span class="line">    &quot;index.search.slowlog.threshold.fetch.debug&quot;: &quot;500ms&quot;,</span><br><span class="line">    &quot;index.search.slowlog.threshold.fetch.trace&quot;: &quot;200ms&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;version&quot;  : 1</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">PUT &#123;INDEX_PAATERN&#125;&#x2F;_settings</span><br><span class="line">&#123;</span><br><span class="line">    &quot;index.indexing.slowlog.level&quot;: &quot;INFO&quot;,</span><br><span class="line">    &quot;index.indexing.slowlog.threshold.index.warn&quot;: &quot;10s&quot;,</span><br><span class="line">    &quot;index.indexing.slowlog.threshold.index.info&quot;: &quot;5s&quot;,</span><br><span class="line">    &quot;index.indexing.slowlog.threshold.index.debug&quot;: &quot;2s&quot;,</span><br><span class="line">    &quot;index.indexing.slowlog.threshold.index.trace&quot;: &quot;500ms&quot;,</span><br><span class="line">    &quot;index.indexing.slowlog.source&quot;: &quot;1000&quot;,</span><br><span class="line">    &quot;index.search.slowlog.level&quot;: &quot;INFO&quot;,</span><br><span class="line">    &quot;index.search.slowlog.threshold.query.warn&quot;: &quot;10s&quot;,</span><br><span class="line">    &quot;index.search.slowlog.threshold.query.info&quot;: &quot;5s&quot;,</span><br><span class="line">    &quot;index.search.slowlog.threshold.query.debug&quot;: &quot;2s&quot;,</span><br><span class="line">    &quot;index.search.slowlog.threshold.query.trace&quot;: &quot;500ms&quot;,</span><br><span class="line">    &quot;index.search.slowlog.threshold.fetch.warn&quot;: &quot;1s&quot;,</span><br><span class="line">    &quot;index.search.slowlog.threshold.fetch.info&quot;: &quot;800ms&quot;,</span><br><span class="line">    &quot;index.search.slowlog.threshold.fetch.debug&quot;: &quot;500ms&quot;,</span><br><span class="line">    &quot;index.search.slowlog.threshold.fetch.trace&quot;: &quot;200ms&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">这样，在日志目录下的慢查询日志就会有输出记录必要的信息了:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;CLUSTER_NAME&#125;_index_indexing_slowlog.log</span><br><span class="line">&#123;CLUSTER_NAME&#125;_index_search_slowlog.log</span><br></pre></td></tr></table></figure><h3><span id="fu-wu-qi-fang-mian-de-you-hua">服务器方面的优化</span><a href="#fu-wu-qi-fang-mian-de-you-hua" class="header-anchor"></a></h3><h4><span id="nei-cun-she-zhi">内存设置</span><a href="#nei-cun-she-zhi" class="header-anchor"></a></h4><ul><li>由于ES构建基于lucene, 而lucene设计强大之处在于lucene能够很好的利用操作系统内存来缓存索引数据，以提供快速的查询性能。lucene的索引文件segements是存储在单文件中的，并且不可变，对于OS来说，能够很友好地将索引文件保持在cache中，以便快速访问；因此，我们很有必要将一半的物理内存留给lucene ; 另一半的物理内存留给ES（JVM heap )。所以， 在ES内存设置方面，可以遵循以下原则：</li></ul><ol><li>当机器内存小于64G时，遵循通用的原则，50%给ES，50%留给lucene。</li><li>当机器内存大于64G时，遵循以下原则：</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">      a. 如果主要的使用场景是全文检索, 那么建议给ES Heap分配 4~32G的内存即可；其它内存留给操作系统, 供lucene使用（segments cache), 以提供更快的查询性能。</span><br><span class="line">      b.  如果主要的使用场景是聚合或排序， 并且大多数是numerics, dates, geo_points 以及not_analyzed的字符类型， 建议分配给ES Heap分配 4~32G的内存即可，其它内存留给操作系统，供lucene使用(doc values cache)，提供快速的基于文档的聚类、排序性能。 </span><br><span class="line">      c.  如果使用场景是聚合或排序，并且都是基于analyzed 字符数据，这时需要更多的 heap size, 建议机器上运行多ES实例，每个实例保持不超过50%的ES heap设置(但不超过32G，堆内存设置32G以下时，JVM使用对象指标压缩技巧节省空间)，50%以上留给lucene。</span><br><span class="line">      d. 当机器内存大于等于64G时，我们都会采用 31 G 设置</span><br><span class="line">          -Xms 31g</span><br><span class="line">          -Xmx 31g</span><br></pre></td></tr></table></figure><ol start="3"><li>禁止swap，一旦允许内存与磁盘的交换，会引起致命的性能问题。 通过： 在elasticsearch.yml 中 bootstrap.memory_lock: true， 以保持JVM锁定内存，保证ES的性能。</li><li>GC设置原则：</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">      a. 保持GC的现有设置，默认设置为：Concurrent-Mark and Sweep (CMS)，别换成G1GC，因为目前G1还有很多BUG。</span><br><span class="line">      b. 保持线程池的现有设置，目前ES的线程池较1.X有了较多优化设置，保持现状即可；默认线程池大小等于CPU核心数。如果一定要改，按公式（（CPU核心数* 3）&#x2F; 2）+ 1 设置；不能超过CPU核心数的2倍；但是不建议修改默认配置，否则会对CPU造成硬伤。</span><br><span class="line">      c.调整  elasticsearch.yml ，对 bulk&#x2F;flush 线程池进行调优</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    threadpool.bulk.type:fixed</span><br><span class="line">    threadpool.bulk.size:8 #(CPU核数)</span><br><span class="line">    threadpool.flush.type:fixed</span><br><span class="line">    threadpool.flush.size:8 #(CPU核数)</span><br></pre></td></tr></table></figure><h4><span id="ji-qun-fen-pian-she-zhi">集群分片设置</span><a href="#ji-qun-fen-pian-she-zhi" class="header-anchor"></a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ES一旦创建好索引后，就无法调整分片的设置，而在ES中，一个分片实际上对应一个lucene 索引，而lucene索引的读写会占用很多的系统资源，因此，分片数不能设置过大；所以，在创建索引时，合理配置分片数是非常重要的。一般来说，我们遵循一些原则：</span><br><span class="line">    6.1 控制每个分片占用的硬盘容量不超过ES的最大JVM的堆空间设置（一般设置不超过32G，参加上文的JVM设置原则），因此，如果索引的总容量在500G左右，那分片大小在16个左右即可；当然，最好同时考虑原则6.2。</span><br><span class="line">    6.2 考虑一下node数量，一般一个节点有时候就是一台物理机，如果分片数过多，大大超过了节点数，很可能会导致一个节点上存在多个分片，一旦该节点故障，即使保持了1个以上的副本，同样有可能会导致数据丢失，集群无法恢复。所以， 一般都设置分片数不超过节点数的3倍。</span><br></pre></td></tr></table></figure><h4><span id="mapping-jian-mo">Mapping建模</span><a href="#mapping-jian-mo" class="header-anchor"></a></h4><ul><li>尽量避免使用nested或 parent/child，能不用就不用；nested query慢， parent/child query 更慢，比nested query慢上百倍；因此能在mapping设计阶段搞定的（大宽表设计或采用比较smart的数据结构），就不要用父子关系的mapping。</li><li>如果一定要使用nested fields，保证nested fields字段不能过多，目前ES默认限制是50。参考：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    index.mapping.nested_fields.limit ：50</span><br><span class="line">    因为针对1个document, 每一个nested field, 都会生成一个独立的document, 这将使Doc数量剧增，影响查询效率，尤其是JOIN的效率。</span><br></pre></td></tr></table></figure><ul><li>避免使用动态值作字段(key), 动态递增的mapping，会导致集群崩溃；同样，也需要控制字段的数量，业务中不使用的字段，就不要索引。控制索引的字段数量、mapping深度、索引字段的类型，对于ES的性能优化是重中之重。以下是ES关于字段数、mapping深度的一些默认设置：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    index.mapping.nested_objects.limit :10000</span><br><span class="line">    index.mapping.total_fields.limit:1000</span><br><span class="line">    index.mapping.depth.limit: 20</span><br></pre></td></tr></table></figure><h4><span id="suo-yin-you-hua-she-zhi">索引优化设置</span><a href="#suo-yin-you-hua-she-zhi" class="header-anchor"></a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">8.1 设置refresh_interval 为-1，同时设置number_of_replicas 为0，通过关闭refresh间隔周期，同时不设置副本来提高写性能。 </span><br><span class="line">    8.2 修改index_buffer_size 的设置，可以设置成百分数，也可设置成具体的大小，大小可根据集群的规模做不同的设置测试。 </span><br><span class="line">        indices.memory.index_buffer_size：10%（默认）</span><br><span class="line">        indices.memory.min_index_buffer_size： 48mb（默认）</span><br><span class="line">        indices.memory.max_index_buffer_size</span><br><span class="line">    8.3 修改translog相关的设置：</span><br><span class="line">        a. 控制数据从内存到硬盘的操作频率，以减少硬盘IO。可将sync_interval的时间设置大一些。</span><br><span class="line">            index.translog.sync_interval：5s(默认)。</span><br><span class="line">        b. 控制tranlog数据块的大小，达到threshold大小时，才会flush到lucene索引文件。</span><br><span class="line">            index.translog.flush_threshold_size：512mb(默认)</span><br><span class="line">    8.4 _id字段的使用，应尽可能避免自定义_id, 以避免针对ID的版本管理；建议使用ES的默认ID生成策略或使用数字类型ID做为主键。</span><br><span class="line">    8.5 _all字段及_source字段的使用，应该注意场景和需要，_all字段包含了所有的索引字段，方便做全文检索，如果无此需求，可以禁用；_source存储了原始的document内容，如果没有获取原始文档数据的需求，可通过设置includes、excludes 属性来定义放入_source的字段。</span><br><span class="line">    8.6 合理的配置使用index属性，analyzed 和not_analyzed，根据业务需求来控制字段是否分词或不分词。只有 groupby需求的字段，配置时就设置成not_analyzed, 以提高查询或聚类的效率。</span><br></pre></td></tr></table></figure><h4><span id="cha-xun-you-hua">查询优化</span><a href="#cha-xun-you-hua" class="header-anchor"></a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">9.1 query_string 或 multi_match的查询字段越多， 查询越慢。可以在mapping阶段，利用copy_to属性将多字段的值索引到一个新字段，multi_match时，用新的字段查询。</span><br><span class="line">    9.2 日期字段的查询， 尤其是用now 的查询实际上是不存在缓存的，因此， 可以从业务的角度来考虑是否一定要用now, 毕竟利用query cache 是能够大大提高查询效率的。</span><br><span class="line">    9.3 查询结果集的大小不能随意设置成大得离谱的值， 如query.setSize不能设置成 Integer.MAX_VALUE， 因为ES内部需要建立一个数据结构来放指定大小的结果集数据。</span><br><span class="line">    9.4 尽量避免使用script，万不得已需要使用的话，选择painless &amp; experssions 引擎。一旦使用script查询，一定要注意控制返回，千万不要有死循环（如下错误的例子），因为ES没有脚本运行的超时控制，只要当前的脚本没执行完，该查询会一直阻塞。</span><br><span class="line">    9.5 避免层级过深的聚合查询， 层级过深的group by , 会导致内存、CPU消耗，建议在服务层通过程序来组装业务，也可以通过pipeline的方式来优化。</span><br><span class="line">    9.6 复用预索引数据方式来提高AGG性能：</span><br><span class="line">    如通过 terms aggregations 替代 range aggregations， 如要根据年龄来分组，分组目标是: 少年（14岁以下） 青年（14-28） 中年（29-50） 老年（51以上）， 可以在索引的时候设置一个age_group字段，预先将数据进行分类。从而不用按age来做range aggregations, 通过age_group字段就可以了。</span><br><span class="line">    9.7. Cache的设置及使用：</span><br><span class="line">        a) QueryCache: ES查询的时候，使用filter查询会使用query cache, 如果业务场景中的过滤查询比较多，建议将querycache设置大一些，以提高查询速度。</span><br><span class="line">        indices.queries.cache.size： 10%（默认），可设置成百分比，也可设置成具体值，如256mb。</span><br><span class="line">        当然也可以禁用查询缓存（默认是开启）， 通过index.queries.cache.enabled：false设置。</span><br><span class="line">        b) FieldDataCache: 在聚类或排序时，field data cache会使用频繁，因此，设置字段数据缓存的大小，在聚类或排序场景较多的情形下很有必要，可通过indices.fielddata.cache.size：30% 或具体值10GB来设置。但是如果场景或数据变更比较频繁，设置cache并不是好的做法，因为缓存加载的开销也是特别大的。</span><br><span class="line">        c) ShardRequestCache: 查询请求发起后，每个分片会将结果返回给协调节点(Coordinating Node), 由协调节点将结果整合。</span><br><span class="line">        如果有需求，可以设置开启;  通过设置index.requests.cache.enable: true来开启。</span><br><span class="line">        不过，shard request cache只缓存hits.total, aggregations, suggestions类型的数据，并不会缓存hits的内容。也可以通过设置indices.requests.cache.size: 1%（默认）来控制缓存空间大小。</span><br></pre></td></tr></table></figure><div class="post-announce">感谢您的阅读，本文由 <a href="https://zuoyoulai.github.io">左之右</a> 版权所有。如若转载，请注明出处：左之右（<a href="https://zuoyoulai.github.io/2020/02/03/es%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%AF%87/">https://zuoyoulai.github.io/2020/02/03/es%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%AF%87/</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/2020/02/01/Windows%E5%AE%89%E8%A3%85SecureCRT/" title="Windows安装SecureCRT"><i class="iconfont icon-prev"></i>Windows安装SecureCRT</a></div><div class="post__prev post__prev--right"><a href="/2020/02/03/es-head%E5%AE%89%E8%A3%85/" title="es-head安装">es-head安装<i class="iconfont icon-next"></i></a></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">简介</h3><p class="block__text">A Java Programmer,Never To Late...</p></div><div class="sidebar__block"><h3 class="block__title">文章分类</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/%E8%B5%84%E6%BA%90%E4%B8%8B%E8%BD%BD/">资源下载</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E6%96%87%E7%AB%A0/">学习文章</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%B3%BB%E7%BB%9F/">分布式定时任务系统</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/mybatis/">mybatis</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/es/">es</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/elk/">elk</a><span class="block-list-count">3</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/SecureCRT/">SecureCRT</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Redis/">Redis</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Mq/">Mq</a><span class="block-list-count">1</span><ul class="block-list-child"><li class="block-list-item"><a class="block-list-link" href="/categories/Mq/Rocketmq/">Rocketmq</a><span class="block-list-count">1</span></li></ul></li><li class="block-list-item"><a class="block-list-link" href="/categories/Linux/">Linux</a><span class="block-list-count">5</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Hexo/">Hexo</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Go/">Go</a><span class="block-list-count">3</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/GitHub/">GitHub</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Git/">Git</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Docker/">Docker</a><span class="block-list-count">1</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2020/03/16/mac%E6%93%8D%E4%BD%9C%E8%99%9A%E6%8B%9F%E6%9C%BA/" title="mac操作虚拟机"><div class="item__cover"><img src="https://i.loli.net/2019/12/30/Rim3w489djgM5oX.jpg" alt="mac操作虚拟机"></div><div class="item__info"><h3 class="item__title">mac操作虚拟机</h3><span class="item__text">2020-03-16</span></div></a></li><li class="latest-post-item"><a href="/2020/03/06/%E8%B5%84%E6%BA%90%E5%9C%A8%E7%BA%BF%E4%B8%8E%E4%B8%8B%E8%BD%BD/" title="资源下载"><div class="item__cover"><img src="https://i.loli.net/2020/03/06/huWFzVt4RdjyAgB.jpg" alt="资源下载"></div><div class="item__info"><h3 class="item__title">资源下载</h3><span class="item__text">2020-03-06</span></div></a></li><li class="latest-post-item"><a href="/2020/02/03/es-head%E5%AE%89%E8%A3%85/" title="es-head安装"><div class="item__cover"><img src="https://i.loli.net/2020/01/31/3KObQ8fWtnivdJg.png" alt="es-head安装"></div><div class="item__info"><h3 class="item__title">es-head安装</h3><span class="item__text">2020-02-03</span></div></a></li><li class="latest-post-item"><a href="/2020/02/03/es%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%AF%87/" title="es性能优化篇"><div class="item__cover"><img src="https://i.loli.net/2020/01/31/3KObQ8fWtnivdJg.png" alt="es性能优化篇"></div><div class="item__info"><h3 class="item__title">es性能优化篇</h3><span class="item__text">2020-02-03</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/BeeGo/">BeeGo</a></li><li class="tag-item"><a class="tag-link" href="/tags/Docker/">Docker</a></li><li class="tag-item"><a class="tag-link" href="/tags/Git/">Git</a></li><li class="tag-item"><a class="tag-link" href="/tags/GitHub/">GitHub</a></li><li class="tag-item"><a class="tag-link" href="/tags/Go/">Go</a></li><li class="tag-item"><a class="tag-link" href="/tags/Hexo/">Hexo</a></li><li class="tag-item"><a class="tag-link" href="/tags/Linux/">Linux</a></li><li class="tag-item"><a class="tag-link" href="/tags/Redis/">Redis</a></li><li class="tag-item"><a class="tag-link" href="/tags/Rocketmq/">Rocketmq</a></li><li class="tag-item"><a class="tag-link" href="/tags/SecureCRT/">SecureCRT</a></li><li class="tag-item"><a class="tag-link" href="/tags/Shell/">Shell</a></li><li class="tag-item"><a class="tag-link" href="/tags/Vim/">Vim</a></li><li class="tag-item"><a class="tag-link" href="/tags/docker/">docker</a></li><li class="tag-item"><a class="tag-link" href="/tags/elk/">elk</a></li><li class="tag-item"><a class="tag-link" href="/tags/es/">es</a></li><li class="tag-item"><a class="tag-link" href="/tags/java/">java</a></li><li class="tag-item"><a class="tag-link" href="/tags/mybatis/">mybatis</a></li><li class="tag-item"><a class="tag-link" href="/tags/sql/">sql</a></li><li class="tag-item"><a class="tag-link" href="/tags/xxx-job/">xxx-job</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E7%B3%BB%E7%BB%9F/">分布式定时任务系统</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%AD%A6%E4%B9%A0%E6%96%87%E7%AB%A0/">学习文章</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E7%99%BE%E5%BA%A6%E4%BA%91/">百度云</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E8%B5%84%E6%BA%90%E4%B8%8B%E8%BD%BD/">资源下载</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E8%BF%90%E7%BB%B4/">运维</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">关于</h3><div class="item__content"><p class="item__text">未知为恐惧,任何事情都不要觉得很晚,做了才知道是否有意义。</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Guangzhou, Guangdong Province, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>472023527@qq.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="https://i.loli.net/2019/12/30/AFVmBhJrI9L7k1c.jpg" alt="logo" title="左之右"></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="https://github.com/Mrminfive/hexo-theme-skapp" target="_blank">Skapp</a> 2017 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, made by <a href="https://github.com/Mrminfive" target="_blank">minfive</a>.</p><ul class="footer__social-network clearfix"></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>